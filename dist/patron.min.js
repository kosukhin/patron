"use strict";var e=Object.defineProperty,t=(t,i,s)=>((t,i,s)=>i in t?e(t,i,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[i]=s)(t,"symbol"!=typeof i?i+"":i,s);const i=new Map;class s{constructor(e){this.initiator=e,t(this,"patrons",new Set),t(this,"receive"),i.set(this,this.patrons);let s=null;const r=(e,t)=>{this.patrons.forEach((i=>{this.sendValueToGuest(e,i,t)}))};this.receive=(e,t)=>{const i=()=>{i===s&&r(e,t)};return s=i,queueMicrotask(i),this}}add(e){return e.introduction&&"patron"===e.introduction()&&this.patrons.add(e),this}remove(e){return this.patrons.delete(e),this}distribute(e,t){return this.add(t),this.sendValueToGuest(e,t,{}),this}sendValueToGuest(e,t,i){t.receive(e,{...i,data:{...i?.data??{},initiator:this.initiator,pool:this}})}}var r=Object.defineProperty,o=(e,t,i)=>((e,t,i)=>t in e?r(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,t+"",i);class n{constructor(e,t=null,i=null){this.defaultValue=t,this.theCache=i,o(this,"pool"),this.pool=new s(e)}receive(e,t){return this.theCache=e,this.pool.receive(e,t),this}receiving(e){return null!==this.theCache?e.receive(this.theCache):null!==this.defaultValue&&e.receive(this.defaultValue),this.pool.add(e),this}}class h{constructor(e){this.receiver=e}receive(e,t){return this.receiver(e,t),this}}var c=Object.defineProperty,a=(e,t,i)=>((e,t,i)=>t in e?c(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);class u{constructor(e){a(this,"guests",new Set),a(this,"patronPool"),this.patronPool=new s(e)}receive(e,t){return this.deliverToGuests(e,t),this.patronPool.receive(e,t),this}add(e){return e.introduction&&"guest"!==e.introduction()||this.guests.add(e),this.patronPool.add(e),this}remove(e){return this.guests.delete(e),this.patronPool.remove(e),this}distribute(e,t){return this.add(t),this.receive(e),this}deliverToGuests(e,t){this.guests.forEach((i=>{i.receive(e,t)})),this.guests.clear()}}class l{constructor(e,t){this.baseGuest=e,this.middleFn=t}introduction(){return this.baseGuest.introduction?this.baseGuest.introduction():"guest"}receive(e,t){return this.middleFn(e,t),this}}var d=Object.defineProperty,v=(e,t,i)=>((e,t,i)=>t in e?d(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);var p=Object.defineProperty,b=(e,t,i)=>((e,t,i)=>t in e?p(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,t+"",i);var f=Object.defineProperty,w=(e,t,i)=>((e,t,i)=>t in e?f(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,t+"",i);exports.Cache=n,exports.Chain=class{constructor(){v(this,"theChain"),v(this,"keysKnown",new Set),v(this,"keysFilled",new Set),v(this,"filledChainPool",new u(this)),this.theChain=new n(this,{})}resultArray(e){return this.filledChainPool.add(new l(e,(e=>Object.values(e)))),this.isChainFilled()&&this.theChain.receiving(new h((e=>{this.filledChainPool.receive(Object.values(e))}))),this}result(e){return this.isChainFilled()?(this.filledChainPool.add(e),this.theChain.receiving(new h((e=>{this.filledChainPool.receive(e)})))):this.filledChainPool.add(e),this}receiveKey(e){return this.keysKnown.add(e),new h((t=>{queueMicrotask((()=>{this.theChain.receiving(new h((i=>{this.keysFilled.add(e);const s={...i,[e]:t};this.theChain.receive(s),this.isChainFilled()&&this.filledChainPool.receive(s)})))}))}))}isChainFilled(){return this.keysFilled.size>0&&this.keysFilled.size===this.keysKnown.size}},exports.Factory=class{constructor(e){this.constructorFn=e}create(...e){return new this.constructorFn(...e)}},exports.FactoryDynamic=class{constructor(e){this.creationFn=e}create(...e){return this.creationFn(...e)}},exports.FactoryWithFactories=class{constructor(e,t={}){this.constructorFn=e,this.factories=t}create(...e){return new this.constructorFn(...e,this.factories)}},exports.Guest=h,exports.GuestAware=class{constructor(e){this.guestReceiver=e}receiving(e){return this.guestReceiver(e),e}},exports.GuestCast=class{constructor(e,t){this.sourceGuest=e,this.targetGuest=t}introduction(){return this.sourceGuest.introduction?this.sourceGuest.introduction():"guest"}receive(e,t){return this.targetGuest.receive(e,t),this}},exports.GuestInTheMiddle=l,exports.GuestPool=u,exports.GuestSync=class{constructor(e){this.theValue=e}receive(e){return this.theValue=e,this}value(){return this.theValue}},exports.Patron=class{constructor(e){this.willBePatron=e}introduction(){return"patron"}receive(e,t){return this.willBePatron.receive(e,t),this}},exports.PatronOnce=class{constructor(e){this.baseGuest=e,b(this,"received",!1)}introduction(){return"patron"}receive(e,t){this.received||this.baseGuest.receive(e,t);const i=t?.data;return i?.pool&&i.pool.remove(this),this}},exports.PatronPool=s,exports.Source=class{constructor(e){this.sourceDocument=e,w(this,"pool",new s(this))}receive(e){return this.sourceDocument=e,this.pool.receive(this.sourceDocument),this}receiving(e){return this.pool.distribute(this.sourceDocument,e),this}},exports.removePatronFromPools=e=>{i.forEach((t=>{t.delete(e)}))};
