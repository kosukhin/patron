!function(e){"use strict";class t{constructor(e){this.receiver=e}receive(e,t){return this.receiver(e,t),this}}var i=Object.defineProperty,s=(e,t,s)=>((e,t,s)=>t in e?i(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s)(e,"symbol"!=typeof t?t+"":t,s);const r=new Map;class n{constructor(e){this.initiator=e,s(this,"patrons",new Set),s(this,"receive"),r.set(this,this.patrons);let t=null;const i=(e,t)=>{this.patrons.forEach((i=>{this.sendValueToGuest(e,i,t)}))};this.receive=(e,s)=>{const r=()=>{r===t&&i(e,s)};return t=r,queueMicrotask(r),this}}add(e){return e.introduction&&"patron"===e.introduction()&&this.patrons.add(e),this}remove(e){return this.patrons.delete(e),this}distribute(e,t){return this.add(t),this.sendValueToGuest(e,t,{}),this}sendValueToGuest(e,t,i){t.receive(e,{...i,data:{...i?.data??{},initiator:this.initiator,pool:this}})}}var o=Object.defineProperty,u=(e,t,i)=>((e,t,i)=>t in e?o(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);class a{constructor(e){u(this,"guests",new Set),u(this,"patronPool"),this.patronPool=new n(e)}receive(e,t){return this.deliverToGuests(e,t),this.patronPool.receive(e,t),this}add(e){return e.introduction&&"guest"!==e.introduction()||this.guests.add(e),this.patronPool.add(e),this}remove(e){return this.guests.delete(e),this.patronPool.remove(e),this}distribute(e,t){return this.add(t),this.receive(e),this}deliverToGuests(e,t){this.guests.forEach((i=>{i.receive(e,t)})),this.guests.clear()}}class c{constructor(e,t){this.baseGuest=e,this.middleFn=t}introduction(){return this.baseGuest.introduction?this.baseGuest.introduction():"guest"}receive(e,t){return this.middleFn(e,t),this}}var h=Object.defineProperty,l=(e,t,i)=>((e,t,i)=>t in e?h(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,t+"",i);class d{constructor(e){this.sourceDocument=e,l(this,"pool",new n(this))}receive(e){return this.sourceDocument=e,this.pool.receive(this.sourceDocument),this}receiving(e){return this.pool.distribute(this.sourceDocument,e),this}}var v=Object.defineProperty,w=(e,t,i)=>((e,t,i)=>t in e?v(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,"symbol"!=typeof t?t+"":t,i);class p{constructor(){w(this,"theChain"),w(this,"keysKnown",new Set),w(this,"keysFilled",new Set),w(this,"filledChainPool",new a(this)),this.theChain=new d({})}resultArray(e){return this.filledChainPool.add(new c(e,(e=>Object.values(e)))),this.isChainFilled()&&this.theChain.receiving(new t((e=>{this.filledChainPool.receive(Object.values(e))}))),this}result(e){return this.isChainFilled()?(this.filledChainPool.add(e),this.theChain.receiving(new t((e=>{this.filledChainPool.receive(e)})))):this.filledChainPool.add(e),this}receiveKey(e){return this.keysKnown.add(e),new t((i=>{queueMicrotask((()=>{this.theChain.receiving(new t((t=>{this.keysFilled.add(e);const s={...t,[e]:i};this.theChain.receive(s),this.isChainFilled()&&this.filledChainPool.receive(s)})))}))}))}isChainFilled(){return this.keysFilled.size>0&&this.keysFilled.size===this.keysKnown.size}}class b{constructor(e){this.theValue=e}receive(e){return this.theValue=e,this}value(){return this.theValue}}class f{constructor(e,t){this.sourceGuest=e,this.targetGuest=t}introduction(){return this.sourceGuest.introduction?this.sourceGuest.introduction():"guest"}receive(e,t){return this.targetGuest.receive(e,t),this}}class y{constructor(e){this.guestReceiver=e}receiving(e){return this.guestReceiver(e),e}}class P{callback(e){return new t(e)}chain(){return new p}cast(e,t){return new f(e,t)}middleware(e,t){return new c(e,t)}pool(e){return new a(e)}aware(e){return new y(e)}sync(e){return new b(e)}}class g{constructor(e){this.willBePatron=e}introduction(){return"patron"}receive(e,t){return this.willBePatron.receive(e,t),this}}var m=Object.defineProperty,G=(e,t,i)=>((e,t,i)=>t in e?m(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i)(e,t+"",i);class C{constructor(e){this.baseGuest=e,G(this,"received",!1)}introduction(){return"patron"}receive(e,t){this.received||this.baseGuest.receive(e,t);const i=t?.data;return i?.pool&&i.pool.remove(this),this}}class F{ofGuest(e){return new g(e)}once(e){return new C(e)}pool(e){return new n(e)}}class k{ofValue(e){return new d(e)}applySources(e,t){return((e,t)=>Object.fromEntries(Object.entries(e).map((([e,i])=>i instanceof Function&&t[e]?(t[e],[e,new Proxy(i,{apply:(i,s,r)=>i.apply(s,[...t[e],...r])})]):[e,i]))))(e,t)}}window&&(window.GUEST_LIBRARY={guest:new P,patron:new F,source:new k}),e.Guest=P,e.GuestCallback=t,e.GuestChain=p,e.GuestSync=b,e.Patron=F,e.PatronPool=n,e.Source=k,e.SourceOfValue=d,e.removePatronFromPools=e=>{r.forEach((t=>{t.delete(e)}))}}({});
