<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <h1>Elegant Objects</h1>
    <p>Композиция объектов описывает поведение</p>
    <p>Умножение: num1 * num2 = result</p>
    <div>
      <label>
        num1:
        <input type="number" class="input-1" />
      </label>
    </div>
    <div>
      <label>
        num2:
        <input type="number" class="input-2" />
      </label>
    </div>
    <div>result = <b class="result"></b></div>
    <script type="module">
      import "https://cdn.jsdelivr.net/npm/patron-oop@1.5.2/dist/patron.min.js";

      const gl = window.GUEST_LIBRARY;

      // Presentation of text in document
      class TextInDocument {
        bindTo(selector) {
          const element = document.querySelector(selector);
          return gl.guest.callback((value) => {
            element.innerText = value;
          });
        }
      }

      // Presentation of input with relation to source value
      class Input {
        #source;

        constructor(source) {
          this.#source = source;
        }

        bindTo(selector) {
          const el = document.querySelector(selector);
          this.#source.receiving(
            gl.patron.ofGuest(
              gl.guest.callback((value) => {
                el.value = value;
              }),
            ),
          );
          el.addEventListener("keyup", (e) => {
            this.receive(e.target.value);
          });
          el.addEventListener("change", (e) => {
            this.receive(e.target.value);
          });
          return this;
        }

        receiving(guest) {
          this.#source.receiving(guest);
          return this;
        }

        receive(value) {
          this.#source.receive(value);
          return this;
        }
      }

      // Number presentation
      class NumberOf {
        #source;

        constructor(source) {
          this.#source = source;
        }

        number(guest) {
          this.#source.receiving(guest);
          return this;
        }

        receive(value) {
          this.#source.receive(value);
        }
      }

      // Multiplication
      class Mul {
        #num1;
        #num2;

        constructor(num1, num2) {
          this.#num1 = num1;
          this.#num2 = num2;
        }

        result(guest) {
          const chain = gl.guest.chain();
          this.#num1.number(gl.guest.cast(guest, chain.receiveKey("num1")));
          this.#num2.number(gl.guest.cast(guest, chain.receiveKey("num2")));
          chain.result(
            gl.guest.middleware(guest, ({ num1, num2 }) => {
              guest.receive(num1 * num2);
            }),
          );
        }
      }

      const input1 = new Input(gl.source.ofValue(2)).bindTo(".input-1");
      const input2 = new Input(gl.source.ofValue(2)).bindTo(".input-2");
      const multiplication = new Mul(
        new NumberOf(input1),
        new NumberOf(input2),
      );
      multiplication.result(
        gl.patron.ofGuest(new TextInDocument().bindTo(".result")),
      );
    </script>
  </body>
</html>
